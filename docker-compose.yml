# SuperX - Docker Compose
# For local development and testing
# Run from monorepo root: docker compose up

services:
  # ==========================================================================
  # SuperX Orchestrator (Production Build)
  # ==========================================================================
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: superx-orchestrator
    env_file:
      - .env
    restart: unless-stopped
    environment:
      PORT: 4000
      LOG_LEVEL: info
      # Erlang distribution settings (production-friendly)
      # Use short names by default to avoid FQDN requirements
      RELEASE_DISTRIBUTION: sname
      # Node short name for Erlang distribution (adjust per deployment)
      RELEASE_NODE: orchestrator
      # Provide a strong cookie via .env in production
      RELEASE_COOKIE: ${RELEASE_COOKIE:-dev-cookie-change-me}
      # Pin distribution port range for firewalls/load balancers
      ERL_AFLAGS: "-kernel inet_dist_listen_min 9000 inet_dist_listen_max 9000"
      # Phoenix secret for session/signing (override via .env in prod)
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:-dev-secret-key-change-me}
      # Agents configuration file
      AGENTS_FILE: /home/app/agents.yml
    ports:
      - "4000:4000"
    volumes:
      - ./samples/agents.yml:/home/app/agents.yml:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # SuperX Orchestrator (Development - Hot Reload)
  # ==========================================================================
  orchestrator-dev:
    image: hexpm/elixir:1.19.4-erlang-28.0-debian-bookworm-20250113-slim
    container_name: superx-orchestrator-dev
    working_dir: /app
    environment:
      MIX_ENV: dev
      PORT: 4000
      AGENTS_FILE: /app/agents.yml
    ports:
      - "4000:4000"
    volumes:
      - ./orchestrator:/app
      - ./samples/agents.yml:/app/agents.yml:ro
      - deps:/app/deps
      - build:/app/_build
    command: >
      sh -c "mix local.hex --force &&
             mix local.rebar --force &&
             mix deps.get &&
             mix run --no-halt"
    profiles:
      - dev

volumes:
  deps:
  build:
